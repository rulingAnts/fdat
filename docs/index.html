<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FLEx XML Viewer — Lists, Translated Lists & Phonology</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:18px;background:#fbfbfb;color:#111}
  header{margin-bottom:12px}
  h1{font-size:1.1rem;margin:0}
  textarea{width:720px;max-width:100%;height:220px;font-family:monospace;padding:8px;border:1px solid #ddd;border-radius:6px;background:#fff}
  button{background:#0b6edb;color:white;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:0.85rem}
  button.secondary{background:#ddd;color:#111}
  label.small{font-size:0.9rem;color:#555}
  .viewer{margin-top:18px;background:#fff;border:1px solid #ddd;padding:14px;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
  .section-title{font-weight:600;margin:8px 0;font-size:1rem}
  ul.tree{list-style:none;margin:6px 0 6px 14px;padding-left:10px;border-left:1px dotted #ccc}
  ul.tree li{margin:4px 0;position:relative;padding-left:6px}
  .toggle{cursor:pointer;color:#0b6edb;margin-right:6px;user-select:none}
  .collapsed>ul{display:none}
  .natclass{border:1px solid #ddd;padding:8px;border-radius:6px;margin-bottom:10px;background:linear-gradient(#fff,#f9f9f9)}
  .symbol-pill{background:#f1f8ff;border:1px solid #d6eaff;padding:3px 7px;border-radius:6px;cursor:pointer}
  .symbol-pill:hover{background:#e8f2ff}
  .highlight{background:#fff2b8}
  table.phonemes{width:100%;border-collapse:collapse;margin-top:8px}
  table.phonemes th,table.phonemes td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .translation-others{color:#555;margin-left:6px}
  .small-muted{color:#666;font-size:0.9rem}
</style>
</head>
<body>
<header><h1>FLEx XML Viewer — Lists, Translated Lists & Phonology</h1></header>

<textarea id="xmlInput" placeholder="Paste XML here or choose a file..."></textarea>
<div style="margin-top:8px">
  <button id="transformBtn">Transform</button>
  <button id="resetBtn" class="secondary">Reset</button>
  <label class="small" style="margin-left:10px">
    <input id="showNames" type="checkbox"> Show element names
  </label>
</div>
<div style="margin-top:8px"><input id="fileInput" type="file" accept=".xml,.xml.txt"/></div>

<div id="viewer" class="viewer">
  <div id="renderArea" class="small-muted">Paste or upload an XML file, then click Transform.</div>
</div>

<script>
const byId=id=>document.getElementById(id);
const escapeHtml=s=>String(s||'').replace(/[&<>"]/g,c=>'&'+({'&':'amp','<':'lt','>':'gt','"':'quot'})[c]+';');

let globalState={showNames:false};

byId('fileInput').addEventListener('change',async e=>{
  const f=e.target.files?.[0];if(!f)return;
  byId('xmlInput').value=await f.text();
});
byId('resetBtn').addEventListener('click',()=>{
  byId('xmlInput').value='';
  byId('renderArea').innerHTML='Paste or upload an XML file, then click Transform.';
});
byId('transformBtn').addEventListener('click',()=>{
  const txt=byId('xmlInput').value.trim();
  if(!txt){alert('Paste XML first');return;}
  const p=new DOMParser();
  const xml=p.parseFromString(txt,'application/xml');
  if(xml.querySelector('parsererror')){alert('XML parse error');return;}
  renderDocument(xml);
});
byId('showNames').addEventListener('change',e=>{
  globalState.showNames=e.target.checked;
  document.querySelectorAll('[data-gen-label]').forEach(el=>{
    const lbl=el.getAttribute('data-gen-label');const prev=el.previousSibling;
    if(prev)prev.textContent=globalState.showNames?(lbl+': '):'';
  });
});

function renderDocument(xml){
  const root=xml.documentElement;
  const tag=root.nodeName.toLowerCase();
  const area=byId('renderArea');area.innerHTML='';

  // detect multilingual list (has multiple AUni ws codes)
  if(tag==='list'||tag==='lists'){
    const au=root.querySelectorAll('AUni[ws]');
    const langs=[...new Set(Array.from(au).map(a=>a.getAttribute('ws')))];
    if(langs.length>1){area.appendChild(renderTranslatedListView(root,langs));return;}
    area.appendChild(renderListView(root));return;
  }
  if(tag==='phonology'){area.appendChild(renderPhonologyView(xml));return;}
  area.appendChild(renderGenericView(root));
}

/* ===== Simple monolingual list ===== */
function renderListView(root){
  const cont=document.createElement('div');
  const title=root.querySelector('name')?.textContent?.trim()||'List';
  cont.appendChild(create('div',{cls:'section-title'},title));
  const ul=create('ul',{cls:'tree'});
  const items=root.querySelectorAll(':scope>item');
  items.forEach(it=>ul.appendChild(buildItem(it)));
  cont.appendChild(ul);
  return cont;

  function buildItem(node){
    const li=create('li');
    const sub=node.querySelector(':scope>item');
    const hasSub=!!sub;
    const toggle=create('span',{cls:'toggle'},hasSub?'▾':' ');
    li.appendChild(toggle);
    const nm=node.querySelector('name')?.textContent?.trim()||'(unnamed)';
    const ab=node.querySelector('abbr')?.textContent?.trim()||'';
    const lbl=ab?`${nm} (${ab})`:nm;
    li.appendChild(document.createTextNode(lbl));
    const subs=node.querySelectorAll(':scope>item');
    if(subs.length){
      const ul=create('ul',{cls:'tree'});
      subs.forEach(ch=>ul.appendChild(buildItem(ch)));
      li.appendChild(ul);
      toggle.addEventListener('click',()=>{
        li.classList.toggle('collapsed');
        toggle.textContent=toggle.textContent==='▾'?'▸':'▾';
      });
    }
    return li;
  }
}

/* ===== Multilingual translated list ===== */
function renderTranslatedListView(root,langs){
  const cont=document.createElement('div');
  const title=root.querySelector('Name AUni[ws="en"], Name AUni')?.textContent?.trim()||'Translated List';
  cont.appendChild(create('div',{cls:'section-title'},title));

  // Language checkboxes
  const langBox=document.createElement('div');
  langBox.className='small-muted';
  langBox.textContent='Visible languages: ';
  langs.forEach(l=>{
    const lab=document.createElement('label');
    lab.style.marginRight='10px';
    const cb=document.createElement('input');
    cb.type='checkbox';cb.checked=true;cb.dataset.lang=l;
    cb.addEventListener('change',()=>{renderItems();});
    lab.appendChild(cb);
    lab.appendChild(document.createTextNode(' '+l));
    langBox.appendChild(lab);
  });
  cont.appendChild(langBox);

  const container=document.createElement('div');
  cont.appendChild(container);
  renderItems();
  return cont;

  function renderItems(){
    const visLangs=langs.filter(l=>langBox.querySelector(`input[data-lang="${l}"]`).checked);
    container.innerHTML='';
    const ul=create('ul',{cls:'tree'});
    const poss=root.querySelector('Possibilities,possibilities')||root;
    const top=Array.from(poss.children).filter(c=>c.nodeType===1);
    top.forEach(ch=>ul.appendChild(buildItem(ch,visLangs)));
    container.appendChild(ul);
  }

  function buildItem(node,visLangs){
    const li=create('li');
    const sub=node.querySelector('SubPossibilities,SubPossibility,Possibilities');
    const hasSub=sub&&Array.from(sub.children).some(c=>c.nodeType===1);
    const toggle=create('span',{cls:'toggle'},hasSub?'▾':' ');
    li.appendChild(toggle);
    const nm=node.querySelector('Name');
    const ab=node.querySelector('Abbreviation');
    const names=collectAUni(nm);
    const abbrs=collectAUni(ab);
    const span=document.createElement('span');
    span.innerHTML=buildMultilingualInlineHTML(names,abbrs,visLangs);
    li.appendChild(span);
    if(hasSub){
      const ul=create('ul',{cls:'tree'});
      Array.from(sub.children).forEach(s=>ul.appendChild(buildItem(s,visLangs)));
      li.appendChild(ul);
      toggle.addEventListener('click',()=>{
        li.classList.toggle('collapsed');
        toggle.textContent=toggle.textContent==='▾'?'▸':'▾';
      });
    }
    return li;
  }
}

function collectAUni(node){
  if(!node)return[];
  const a=node.querySelectorAll('AUni');
  return Array.from(a).map(a=>({ws:a.getAttribute('ws')||'',text:a.textContent.trim()}));
}

function buildMultilingualInlineHTML(names,abbrs,visibleLangs){
  if(!names.length)return'(unnamed)';
  const shown=names.filter(n=>visibleLangs.includes(n.ws));
  if(!shown.length)return'(none)';
  const main=shown[0];
  const others=shown.slice(1);
  let html=`<span class="translation-main">${escapeHtml(main.text)}</span>`;
  if(others.length){
    html+=' '+others.map(o=>`<span class="translation-others">${escapeHtml(o.text)}</span>`).join(' · ');
  }
  const abv=abbrs.filter(a=>visibleLangs.includes(a.ws));
  if(abv.length)html+=` <span class="small-muted">[${abv.map(a=>escapeHtml(a.text)).join(' / ')}]</span>`;
  return html;
}

/* ===== Generic recursive fallback ===== */
function renderGenericView(node){
  const cont=document.createElement('div');
  cont.appendChild(create('div',{cls:'section-title'},'Generic XML View'));
  const ul=create('ul',{cls:'tree'});
  ul.appendChild(build(node));
  cont.appendChild(ul);
  return cont;

  function build(n){
    const li=create('li');
    const kids=[...n.childNodes].filter(x=>x.nodeType===1||x.nodeType===3&&x.nodeValue.trim());
    const hasKids=kids.some(k=>k.nodeType===1);
    const t=create('span',{cls:'toggle'},hasKids?'▾':' ');
    li.appendChild(t);
    const label=n.nodeType===1?n.nodeName:'';
    const nameSpan=document.createElement('span');
    if(globalState.showNames&&label){
      nameSpan.textContent=label+': ';
      nameSpan.style.fontWeight='600';
    }
    li.appendChild(nameSpan);
    if(n.nodeType===3){
      li.appendChild(document.createTextNode(n.nodeValue.trim()));
    } else {
      const text=n.textContent.trim();
      if(hasKids){
        const ul=create('ul',{cls:'tree'});
        kids.forEach(k=>ul.appendChild(build(k)));
        li.appendChild(ul);
        t.addEventListener('click',()=>{
          li.classList.toggle('collapsed');
          t.textContent=t.textContent==='▾'?'▸':'▾';
        });
      } else if(text){li.appendChild(document.createTextNode(text));}
    }
    if(n.nodeType===1)li.setAttribute('data-gen-label',n.nodeName);
    return li;
  }
}

/* ===== Phonology simplified ===== */
function renderPhonologyView(xml){
  const cont=create('div');
  cont.appendChild(create('div',{cls:'section-title'},'Phonology Export Detected'));
  const root=xml.documentElement;
  const phonData=root.querySelector('PhPhonData');
  if(!phonData){cont.appendChild(renderGenericView(root));return cont;}

  // Natural classes
  const nat=phonData.querySelectorAll('NaturalClasses > PhNCSegments');
  if(nat.length){
    cont.appendChild(create('div',{cls:'section-title'},'Natural Classes'));
    nat.forEach(cls=>{
      const div=create('div',{cls:'natclass'});
      const name=cls.querySelector('Name AUni,Name')?.textContent?.trim()||'(unnamed)';
      const abbr=cls.querySelector('Abbreviation AUni,Abbreviation')?.textContent?.trim()||'';
      div.innerHTML=`<strong>${escapeHtml(name)}</strong> ${escapeHtml(abbr)}`;
      cont.appendChild(div);
    });
  }

  // Phoneme set
  const set=phonData.querySelector('PhonemeSets > PhPhonemeSet');
  if(set){
    cont.appendChild(create('div',{cls:'section-title'},'Phoneme Inventory'));
    const table=document.createElement('table');
    table.className='phonemes';
    table.innerHTML='<thead><tr><th>Symbol</th><th>Description</th></tr></thead>';
    const body=document.createElement('tbody');
    const phs=set.querySelectorAll('PhPhoneme');
    phs.forEach(ph=>{
      const tr=document.createElement('tr');
      const sym=ph.querySelector('Name AUni,Name')?.textContent?.trim()||'';
      const desc=ph.querySelector('Description Run,Description')?.textContent?.trim()||'';
      tr.innerHTML=`<td>${escapeHtml(sym)}</td><td>${escapeHtml(desc)}</td>`;
      body.appendChild(tr);
    });
    table.appendChild(body);
    cont.appendChild(table);
  }
  return cont;
}

/* ===== Utility ===== */
function create(t,a={},text){
  const e=document.createElement(t);
  for(const k in a){if(k==='cls')e.className=a[k];else e.setAttribute(k,a[k]);}
  if(text!==undefined)e.textContent=text;
  return e;
}
</script>
<footer style="margin-top:40px;padding-top:10px;border-top:1px solid #ddd;font-size:0.8rem;color:#555">
  <p>
    © 2025 Seth Johnston.  
    This software is licensed under the
    <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank" rel="noopener noreferrer">GNU Affero General Public License v3.0</a>.
  </p>
  <p>
    Portions of this code were generated collaboratively with <strong>ChatGPT (GPT-5)</strong> by OpenAI,
    under the author’s design direction and supervision.
  </p>
</footer>

</body>
</html>